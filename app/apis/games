#!/bin/bash

[ -x "../utils.sh" ] && source "../utils.sh"

IFS='' read -r -N "${CONTENT_LENGTH}" REQUEST_PAYLOAD </dev/stdin

ROOM_ID="$(echo "${REQUEST_PAYLOAD}" | jq -cr '.roomId')"
GAME_STATE="$(init_game "${REQUEST_PAYLOAD}")"
INSERT_STAT="INSERT INTO games (room_id, game_state) VALUES ('${ROOM_ID}', '${GAME_STATE}');"
sqlite3 "${SQLITE3_FILE}" "${INSERT_STAT}"

SQL_RESULT="$?"
if [ "${SQL_RESULT}" != '0' ]; then
  echo 'Status: 400'
  echo ''
  echo "${SQL_RESULT}" | jq -rc '{error_type: "sqlite", error_code: .}'
  exit -1
fi

INSERTED_ROW_ID="$(
  sqlite3 "${SQLITE3_FILE}" -json "SELECT * from games WHERE room_id='${ROOM_ID}';" | jq -rc '.[0].id'
)"
if [ -z INSERTED_ROW_ID ]; then
  echo 'Status: 404'
  echo ''
  jq -rc '{error_type: "sqlite", error_code: -1}'
  exit -2
fi

echo 'Status: 200'
echo ''
echo "https://example.com/games/${INSERTED_ROW_ID}" | jq -crR '{url: .}'
exit 0
